<!DOCTYPE html>
<meta charset="utf-8" />
<style>
  .links line {
    stroke: #999;
    stroke-opacity: 0.5;
  }

  .nodes circle {
    stroke: #fff;
    stroke-width: 1.5px;
  }

  text {
    font-family: monospace;
    font-size: 8px;
  }
</style>
<p>
  <b>Clean render:</b><br />
  <button type="reset" onclick="location.reload()">reset</button>
</p>
<p>
  <b>Group by:</b><br />
  <input type="form" id="group-type" value="Company" />
</p>
<p>
  <b>Connections (CSV):</b><br />
  <input id="csv" type="file" />
</p>

<p><svg></svg></p>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.11/jquery.csv.min.js"></script>

<script>
  var fileInput = document.getElementById('csv');
  var nodes = [];
  var links = [];

  readFile = function () {
    var reader = new FileReader();
    var groupType = document.getElementById('group-type').value;
    reader.onload = function () {
      connections = $.csv.toObjects(reader.result);
      //console.log(connections);

      nodes.push({
        firstName: 'You',
        lastName: '',
        name: 'You',
        company: '',
      });

      for (source of connections) {
        sourceName = source['First Name'] + ' ' + source['Last Name'];

        links.push({
          source: 'You',
          target: sourceName,
        });

        nodes.push({
          firstName: source['First Name'],
          lastName: source['Last Name'],
          name: sourceName,
          company: source[groupType],
        });

        for (target of connections) {
          targetName = target['First Name'] + ' ' + target['Last Name'];
          if (
            sourceName != targetName &&
            source[groupType] == target[groupType]
          ) {
            links.push({
              source: sourceName,
              target: targetName,
            });
          }
        }
      }

      graph = {
        nodes: nodes,
        links: links,
      };

      //console.log(graph);
      render(graph);
    };
    reader.readAsBinaryString(fileInput.files[0]);
  };

  fileInput.addEventListener('change', readFile);

  var simulation;

  function render(graph) {
    var width = 7000;
    var height = 7000;

    var svg = d3.select('svg').attr('width', width).attr('height', height);
    var color = d3.scaleOrdinal(d3.schemeCategory20);

    simulation = d3
      .forceSimulation()
      .force(
        'link',
        d3.forceLink().id(function (d) {
          return d.name;
        })
      )
      .force(
        'charge',
        d3
          .forceManyBody()
          .strength(-500)
          .distanceMax(0.3 * Math.min(width, height))
      )
      .force('center', d3.forceCenter(width / 2, height / 2));

    var link = svg
      .append('g')
      .attr('class', 'links')
      .selectAll('line')
      .data(graph.links)
      .enter()
      .append('line')
      .attr('stroke-width', function (d) {
        return color(d.company);
      });

    var node = svg
      .append('g')
      .attr('class', 'nodes')
      .selectAll('g')
      .data(graph.nodes)
      .enter()
      .append('g');

    var circles = node
      .append('circle')
      .attr('r', 5)
      .attr('fill', function (d) {
        return color(d.company);
      });

    var lables = node
      .append('text')
      .text(function (d) {
        return d.name;
      })
      .attr('x', 6)
      .attr('y', 3);

    node.append('title').text(function (d) {
      return d.company;
    });

    simulation.nodes(graph.nodes).on('tick', ticked);
    simulation.force('link').links(graph.links);

    function ticked() {
      link
        .attr('x1', function (d) {
          return d.source.x;
        })
        .attr('y1', function (d) {
          return d.source.y;
        })
        .attr('x2', function (d) {
          return d.target.x;
        })
        .attr('y2', function (d) {
          return d.target.y;
        });

      node.attr('transform', function (d) {
        return 'translate(' + d.x + ',' + d.y + ')';
      });
    }
  }
</script>
